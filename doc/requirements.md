# カスタム画像パズル - 要件定義書

## プロジェクト概要
自分の画像をアップロードしたり、AIで画像を生成してパズルで遊べるスライドパズルゲーム。

### UIモック（2025-11-19更新）
![ネオンフォレストをテーマにしたスライドパズルUI](../png/nano-banana-1763530962994.png)
- タイトル配下に「タイムアタック」「手数省エネ」などのチップ型モードトグルを配置し、現在モードをハイライト
- ボード右上に経過時間・現在手数・サイズをまとめたHUDカードを重ねる
- 右側にAI参謀パネル（ヒント / 最適解表示 / プレイスタイル分析グラフ）を縦配置
- 下部には初級/中級/上級ボタンとカスタムサイズスライダー（4×4〜10×10）を並べる
- 左下に「オフラインで遊べます」インジケータを常時表示してPWA状態を可視化

## 目的・課題
- **目的**: 自分だけのオリジナル画像パズルで楽しく遊べる
- **課題**: 既存のパズルは固定画像で飽きやすい、自分の好きな画像で遊べない
- **解決策**: 画像アップロード + AI画像生成で、無限のバリエーションを提供

## ターゲットユーザー
- **メイン**: 大人・家族
- **サブ**: 子供
- **特徴**: 幅広い年齢層、カジュアルに楽しめる

---

## 機能要件

### 1. 画像選択機能（3つの方法）

#### 1.1 画像アップロード
- **機能**: ユーザーが自分の画像をアップロード
- **対応形式**: JPEG、PNG、GIF
- **画像処理**: 正方形にトリミング、適切なサイズにリサイズ
- **プレビュー**: アップロード後に画像全体をプレビュー表示

#### 1.2 AI画像生成（Gemini 2.5 Flash Image "nano-banana"）
- **機能**: テキストプロンプトから画像を生成
- **実装**: Google Gemini 2.5 Flash Image API（モデルID: `gemini-2.5-flash-image`、コードネーム: nano-banana）を使用
- **UI**:
  - テキスト入力欄（例：「猫が宇宙で遊んでいる」）
  - 生成ボタン
  - 生成中のローディング表示
  - 生成画像のプレビュー
- **制限**: 1回の生成に数秒かかることをユーザーに明示
- **注意**: 旧Imagen 4.0からの差し替えのため、環境変数・設定モーダルのラベルもGemini 2.5 Flash Imageに統一

#### 1.3 プリセット画像
- **機能**: あらかじめ用意した画像から選択
- **カテゴリ**:
  - 動物（犬、猫、パンダなど）
  - 海の生物（イルカ、クラゲ、サンゴ礁など）
  - 景色（山、海、夕日など）
- **画像数**: 各カテゴリ3〜5枚程度

### 2. パズル機能

#### 2.1 パズルサイズ
- **4×4**（15ピース）：初級、UI下部の「初級」チップで選択
- **5×5**（24ピース）：中級、「中級」チップで選択
- **9×9**（80ピース）：上級、モックに合わせて「上級（9×9）」と明記
- **カスタムサイズ**：4×4〜10×10をスライダーで選択し、リアルタイムで「10×10」などのラベルを表示

#### 2.2 画像分割
- 選択した画像を指定サイズに分割
- 最後のピース（右下）を空きマスに設定
- タイルに画像の該当部分を表示
- **シングルブランク必須**: 空きマスは常に1枚のみ存在し、空きマスが無い状態ではタイル移動を一切許可しない
- **無効操作防止**: 空きマスに隣接していないタイルをクリック/タップした場合は、軽いバイブレーションやシェイクで無効操作をフィードバック

#### 2.3 タイル操作
- **移動方法**: タップ/クリックで移動
- **移動可能判定**: 空きマスに隣接するタイルのみ移動可能
- **アニメーション**: スムーズなスライドアニメーション（300ms）
- **効果音**: タイル移動時に「ピコン」音を再生

#### 2.4 完成判定
- 全てのタイルが正しい位置に配置されたら完成
- 完成時にアニメーションと効果音で祝福

#### 2.5 表示モードとHUD
- **画像モードトグル**: ボード左上に配置し、画像 / 番号 / アウトライン表示を即切り替え。
- **シャッフル回数表示**: トグル隣に「シャッフル10回」などのメーターピルを表示。
- **HUDカード**: 経過時間（02:15）、現在手数（42手）、盤面サイズ（上級 9×9）をまとめたカードをボード右上に重ねる。
- **AI参謀パネル**: ヒント、最適解表示、プレイスタイル分析を1つの縦長カードに集約。
- **オフラインインジケータ**: 左下のピルでPWA状態を表示（オンライン/オフライン/再接続中）。

### 3. ゲームモード

#### 3.1 フリープレイモード
- 時間・手数制限なし
- 練習・リラックスして遊べる

#### 3.2 タイムアタックモード
- 制限時間内にクリア
- 制限時間:
  - 初級（4×4）: 3分
  - 中級（5×5）: 5分
  - 上級（6×6）: 10分
- タイムアップでゲームオーバー

#### 3.3 手数チャレンジモード
- 最小手数でクリアを目指す
- 手数制限なし、手数をカウント
- クリア後に「最適解との差」を表示

#### 3.4 モード切り替えUI
- タイトル直下にチップ形式のモードセレクタを配置（例: 「タイムアタック」「手数省エネ」）。
- 選択中モードはネオンブルーで強調し、非選択モードは半透明＋細枠で表示。
- モード変更に応じてHUDラベル（制限時間の残り表示など）とAIパネルの推奨コンテンツを即時切り替え。

### 4. AI機能（Gemini 2.5 Flash使用）

#### 4.1 ヒント機能
- **機能**: 次の最適な一手をAIが提案
- **実装**: A*アルゴリズムで最適な一手を計算 → AIが理由を説明
- **表示内容**:
  - 「このタイル（画像の一部を表示）を上に動かしましょう」
  - 「理由: この移動で左上エリアが整理されます」
- **制限**: 1ゲームにつき3回まで
- **APIキー**: ユーザーが設定可能（localStorage保存）

#### 4.2 最適解表示
- **機能**: パズルの最適解をステップバイステップで表示
- **実装**: A*アルゴリズムで最適解を計算
- **表示内容**:
  - 各ステップの画像付きで表示
  - 「1. このタイルを右に移動」
  - 「2. このタイルを下に移動」
- **制約**: 最適解表示中は手数・時間カウント停止

#### 4.3 プレイスタイル分析
- **機能**: クリア後にAIがプレイを分析
- **分析項目**:
  - 手数 vs 最適解
  - 効率性スコア
  - 改善ポイント
- **アドバイス例**:
  - 「効率85%！素晴らしいプレイです」
  - 「無駄な移動を3手減らすと、さらに良くなります」
- **UI**: AI参謀パネル内の折れ線グラフに最新3ゲームを反映し、節点を蛍光グリーンのドットで強調。

-#### 4.4 AI設定UI
- **専用画面**: 右上の「AI設定」ボタンからモーダル/サイドシートを開き、AI機能関連の設定をまとめて行えるようにする
- **APIキー管理**: Gemini（テキスト/ヒント用）と Gemini 2.5 Flash Image（画像生成用）それぞれのAPIキー入力欄、貼り付け→保存→マスク表示、削除ボタンを用意し、localStorageに暗号化保存
- **AI補助トグル**: 「ヒントを有効にする」「AI分析を自動表示する」等のトグルと、1ゲームあたりのヒント回数上限（1〜5）のドロップダウン
- **ステータス表示**: 現在のキー有効性（成功/失敗）をバッジで表示し、検証はServer Action経由で即時フィードバック
- **ガイドコピー**: 利用規約・料金についての注意喚起と、APIキーの取得手順リンクを設置

### 5. 統計・記録機能

#### 5.1 リアルタイム表示
- **タイマー**: MM:SS形式で経過時間表示
- **手数カウント**: 現在の手数を表示
- **難易度**: 選択中のサイズを表示

#### 5.2 プレイ履歴
- **保存項目**:
  - 日時
  - 画像（サムネイル）
  - パズルサイズ
  - クリアタイム
  - 手数
  - 効率性スコア
- **表示**: 一覧形式でソート可能

#### 5.3 統計グラフ
- クリアタイムの推移
- 手数の推移
- 難易度別のベストスコア
- プレイ中画面では右側のミニチャートに最新3ゲームの効率推移を表示し、詳細統計画面へリンクする

### 6. PWA対応（必須要件）

#### 6.1 オフライン対応
- **Service Worker**: 完全オフライン動作
- **オフライン機能**:
  - パズル生成・プレイ
  - プリセット画像の使用
  - スコア記録（IndexedDB）
  - A*アルゴリズムによる最適解計算
- **オンライン専用機能**:
  - AI画像生成（Gemini 2.5 Flash Image）
  - AIヒント・分析（Gemini）
- **オフライン表示要件**: サービスワーカーの状態に応じて左下バッジの文言・色を切り替え。「オフラインで遊べます」「再接続しています」などを即時反映。

#### 6.2 インストール可能
- **Manifest.json**: アプリアイコン、名前、テーマカラー設定
- **スタンドアロンモード**: ブラウザUIなしで起動
- **アプリアイコン**: 192×192、512×512
- **モバイルアイコン要件**:
  - iOS: 180×180、152×152、120×120（角丸なしPNG）を用意し、ダーク/ライトテーマでも視認性を確保
  - Android: 192×192、256×256、512×512（透過背景）に加えてAdaptive Icon（foreground/backgroundレイヤー）を用意
  - デザイン: ネオンフォレストをモチーフにしたシンボルを作成し、既存`pwa-icon.png`を置き換える

---

## 技術制約

### 必須技術スタック
- **フロントエンド**: Next.js 14.x / React 18.x
- **スタイリング**: Tailwind CSS v3
- **PWA**: Service Worker、Manifest.json
- **AI API**:
  - Google Gemini API（gemini-2.5-flash）：ヒント・分析
  - Google Gemini 2.5 Flash Image（gemini-2.5-flash-image / nano-banana）：画像生成
- **データ保存**: IndexedDB（ローカルストレージ）
- **パズルアルゴリズム**: A*アルゴリズム（最適解計算）

### API要件
- **APIキー管理**:
  - ユーザーがブラウザ上で設定（localStorage）
  - 設定モーダルでAPIキー入力・保存・削除
  - 環境変数（.env.local）でのフォールバックも対応

---

## 環境要件
- **開発環境**: WSL2 Ubuntu + Windows
- **ブラウザ**: Chrome、Firefox、Safari（最新版）
- **レスポンシブ**: デスクトップ、タブレット、スマートフォン対応

---

## デザイン要求

### デザイン方向性
- **テイスト**: ポップな感じ
- **カラースキーム**:
  - 夜明けの森を思わせるネオンブルー〜パープルのグラデーション
  - ガラスモーフィズム＋白い輪郭でカードを浮かせる
  - CTAはティールやサンセットオレンジでアクセントを付ける
- **対象年齢**: 大人〜子供まで親しみやすいデザイン

### UI/UX要求
- **シンプル操作**: タップ/クリックで直感的に遊べる
- **視覚的フィードバック**:
  - タイル移動時のアニメーション
  - 効果音（ピコン音）
- **情報レイヤー**: HUD・AIパネル・難易度チップ・オフラインバッジを分離し、影とグローで階層を表現
- **レスポンシブ**: デスクトップでは右側パネル、モバイルでは下部に折り返して同じ機能を提供
- **コピー**: 「ヒント」「最適解表示」「ブレイスタイル分析」など、モックに合わせたラベルを採用
  - 完成時の祝福演出
- **アクセシビリティ**:
  - 大きなボタン
  - 見やすいフォント
  - 色覚に配慮した配色

---

## 成功基準

### 機能面
- ✅ 画像アップロード・AI生成・プリセットの3つの方法で画像選択可能
- ✅ 4×4、5×5、6×6のパズルが正しく動作
- ✅ AI ヒント・最適解が正確（6×6は数十秒以内）
- ✅ オフラインで基本機能が完全動作

### パフォーマンス
- ✅ タイル移動のアニメーション < 300ms
- ✅ 画像アップロード処理 < 1秒
- ✅ AI画像生成 < 10秒
- ✅ AIヒント生成 < 3秒
- ✅ 最適解計算（A*）:
  - 4×4: < 1秒
  - 5×5: < 5秒
  - 6×6: < 30秒
- ✅ Lighthouse スコア 90点以上

### ユーザビリティ
- ✅ 初回訪問から1分以内にプレイ開始可能
- ✅ 画像選択が直感的
- ✅ タイル操作が快適
- ✅ AIキー未設定でも基本機能は使える

---

## スケジュール
- **要件定義**: 完了
- **技術設計**: 次フェーズ
- **実装計画**: TDD準拠で作成
- **実装**: 後日（実装計画書完成後）

---

## 備考
- 100Appsプロジェクト中期要件（31〜60番）に準拠
- AI機能必須、PWA必須
- 将来的な拡張: マルチプレイヤー、SNSシェア機能
